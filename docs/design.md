# OpenBaccarat 设计文档

## 1. 项目概述

### 1.1 项目愿景

OpenBaccarat 是一个**完全开源、透明可验证**的百家乐游戏平台。通过区块链技术实现游戏结果的不可篡改存证，配合精美的 3D 动画效果，为用户提供真实、刺激的观看体验。

### 1.2 核心价值

| 价值点 | 描述 |
|--------|------|
| 🔓 **完全开源** | 算法、代码、历史记录全部公开透明 |
| ⛓️ **区块链存证** | 每局结果写入 Solana，永久不可篡改 |
| 🎰 **可验证公平** | 使用 VRF 随机数，任何人可验证 |
| 🎬 **极致视觉** | 3D 扑克牌弯折动画，媲美真实赌场 |
| 📊 **完整记录** | 每张牌、每一局、每个牌靴完整追溯 |

### 1.3 项目定位

- **纯展示平台**：不涉及真金下注
- **开源项目**：任何人可审计、可 Fork
- **教育意义**：展示公平随机算法的实现

---

## 2. 功能设计

### 2.1 核心功能

#### 2.1.1 游戏展示

```
┌─────────────────────────────────────────────────────────────┐
│  🕐 当前时间: 2026-01-26 14:35:22 (GMT+8)     📊 局号: #123456 │
├─────────────────────────────────────────────────────────────┤
│                      3D 百家乐牌桌                           │
│  ┌─────────────┐                      ┌─────────────┐       │
│  │   闲家区域   │                      │   庄家区域   │       │
│  │  Player     │                      │   Banker    │       │
│  │  [🂡] [🂢]   │                      │  [🂣] [🂤]   │       │
│  │   点数: 5    │                      │   点数: 7    │       │
│  └─────────────┘                      └─────────────┘       │
│                                                              │
│           ⏱️ 倒计时: 00:45  |  🎯 下一局: 14:36:00           │
│                    🏆 结果: 庄家胜                            │
└─────────────────────────────────────────────────────────────┘
```

**时间显示：**

| 元素 | 说明 |
|------|------|
| 🕐 当前时间 | 用户当地时间，实时更新 |
| ⏱️ 倒计时 | 距离下一局的秒数 |
| 🎯 下一局时间 | 下一局开始的当地时间 |
| 时区标识 | 显示用户时区 (如 GMT+8) |

**游戏节奏：**

- **每分钟一局**：全球同步，整分开局 (如 14:35:00, 14:36:00)
- **实时动画**：发牌、翻牌、咪牌动画
- **结果展示**：庄胜/闲胜/和局

#### 2.1.2 历史记录查询

**两种视图模式（可切换）：**

| 视图 | 说明 |
|------|------|
| 📋 **列表视图** | 传统表格形式，显示每局详细信息 |
| 🎯 **路单视图** | 赌场风格网格图，包含多种路单 |

**列表视图字段：**

| 字段 | 说明 |
|------|------|
| 局号 | 点击可查看详情 |
| 结果 | 庄胜/闲胜/和局 |
| 点数 | 庄家:闲家 (如 7:5) |
| 对子 | 庄对/闲对标记 |
| 天牌 | 是否为天牌 (8或9) |
| 时间 | 开局时间 |
| 🔗 链上验证 | 点击跳转 Solana Explorer |

**路单视图（4种子视图可切换）：**

```
┌─────────────────────────────────────────────────────────────────────────┐
│  [大路] [大眼仔] [小路] [珠盘路]                    统计: 庄28 闲29 和2  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  ┌──────────────────────────────────────────────────────────────────┐   │
│  │  ○ ○ ○ ○ ○ ○ ○ ● ○ ○ ○ ●     ← 红圈=庄胜 蓝圈=闲胜             │   │
│  │    ○   ○       ● ○   ○       ← 同一列=连续相同结果              │   │
│  │        ○       ●     ○       ← 换列=结果改变                    │   │
│  │        ○       ●             ← 圈内小点=对子                    │   │
│  │        ○       ●             ← 斜线=和局                        │   │
│  └──────────────────────────────────────────────────────────────────┘   │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

**路单类型详解：**

| 路单 | 英文 | 说明 | 用途 |
|------|------|------|------|
| **大路** | Big Road | 最基础的路单，红蓝圈记录庄闲胜负 | 直观查看历史走势 |
| **大眼仔路** | Big Eye Boy | 基于大路推算，判断路单是否"整齐" | 进阶分析 |
| **小路** | Small Road | 类似大眼仔，但隔一列比较 | 进阶分析 |
| **珠盘路** | Bead Plate | 数字网格，显示具体点数 | 查看每局详细点数 |

**珠盘路示例：**
```
┌────────────────────────────────────────┐
│  5  9  8  6  6  7  7  9  9  ← 点数    │
│  🔴 🔵 🔴 🔵 🔴 🔴 🔵 🔴 🔵  ← 颜色=结果 │
│  7  5  4  7  4  4  7  9  5            │
│  🔵 🔴 🔵 🔴 🔵 🔵 🔴 🔵 🔵            │
│  ...                                   │
└────────────────────────────────────────┘
红色数字=庄胜，蓝色数字=闲胜，绿色数字=和局
数字=获胜方的点数
```

**查询功能：**

| 查询维度 | 说明 |
|----------|------|
| 按局号查询 | 输入局号直接跳转 |
| 按时间范围 | 选择日期时间区间 |
| 按结果筛选 | 只看庄胜/闲胜/和局 |
| 按牌靴查询 | 查看某个牌靴的所有局 |

#### 2.1.3 发牌靴追踪

**牌靴信息面板：**

```
┌─────────────────────────────────────────────────────────────┐
│  👟 发牌靴 #42                                  [查看详情]   │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  📊 牌靴状态                                                 │
│  ┌────────────────────────────────────────────────────┐     │
│  │  ████████████████████░░░░░░░░░░░░░░░░░░░░░░░░░░░░  │     │
│  │  已使用 156张                        剩余 260张     │     │
│  └────────────────────────────────────────────────────┘     │
│                                                              │
│  🔥 烧牌信息                                                 │
│  ├── 开头烧牌: 7 张 (根据首张牌点数)                         │
│  └── 尾部保留: 14 张 (切牌卡后)                              │
│                                                              │
│  📈 本牌靴统计                                               │
│  ├── 已进行: 28 局                                          │
│  ├── 庄胜: 14 | 闲胜: 12 | 和局: 2                          │
│  └── 庄对: 3  | 闲对: 2                                     │
│                                                              │
│  🃏 已使用的牌                                               │
│  ┌────────────────────────────────────────────────────┐     │
│  │ ♠: A 2 3 5 7 9 J Q                                 │     │
│  │ ♥: 2 4 4 6 8 10 K                                  │     │
│  │ ♦: A 3 5 7 9 J                                     │     │
│  │ ♣: 2 4 6 8 10 Q K                                  │     │
│  │ (按花色分组显示已用牌)                              │     │
│  └────────────────────────────────────────────────────┘     │
│                                                              │
│  ⛓️ 区块链验证                                               │
│  └── 洗牌种子已上链 [查看 Solana Explorer →]                 │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

**发牌靴数据结构：**

| 数据项 | 说明 |
|--------|------|
| 总牌数 | 8副牌 = 416张 |
| 开头烧牌数 | 根据首张牌点数烧牌（10/J/Q/K=10张） |
| 切牌卡位置 | 距离底部约14-16张 |
| 尾部保留数 | 切牌卡之后的牌（不使用） |
| 可用牌数 | 总牌数 - 开头烧牌 - 尾部保留 |
| 已使用牌数 | 当前已发出的牌数 |
| 剩余可用牌 | 可用牌数 - 已使用牌数 |

#### 2.1.4 链上验证

**每局区块链数据：**

| 数据项 | 说明 |
|--------|------|
| Solana 交易签名 | 唯一标识，可链上查询 |
| Solana Slot | 区块高度 |
| 确认状态 | finalized / confirmed / processing |
| Explorer 链接 | 一键跳转 Solana Explorer |
| VRF 种子 | 可验证随机数 |
| VRF 证明 | 随机数证明（用于验证） |

**牌靴区块链数据：**

| 数据项 | 说明 |
|--------|------|
| 洗牌种子交易签名 | 牌靴初始化时的链上记录 |
| 洗牌种子 | VRF 生成的洗牌随机数 |
| Explorer 链接 | 一键跳转查看 |

#### 2.1.5 时间戳设计

**存储策略（双格式）：**

| 格式 | 用途 | 示例 |
|------|------|------|
| **TIMESTAMPTZ** | 数据库查询、人类可读 | `2026-01-26 14:35:22+00` |
| **Unix timestamp (ms)** | 区块链验证、前端精确计算 | `1737898522000` |

**时间存储说明：**

| 字段 | 存储格式 | 说明 |
|------|----------|------|
| `started_at` | TIMESTAMPTZ | 开局时间 (UTC) |
| `started_at_unix` | BIGINT | 开局时间 (毫秒级 Unix) |
| `completed_at` | TIMESTAMPTZ | 结束时间 (UTC) |
| `completed_at_unix` | BIGINT | 结束时间 (毫秒级 Unix) |

**前端时间转换：**

```javascript
// 后端返回 Unix timestamp (毫秒)
const startedAtUnix = 1737898522000;

// 转换为用户当地时间
const localTime = new Date(startedAtUnix);
const formatted = localTime.toLocaleString('zh-CN', {
  timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone,
  year: 'numeric',
  month: '2-digit',
  day: '2-digit',
  hour: '2-digit',
  minute: '2-digit',
  second: '2-digit'
});
// 输出: "2026/01/26 22:35:22" (GMT+8)

// 获取用户时区
const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
// 输出: "Asia/Shanghai"
```

**为什么用毫秒级 Unix timestamp：**

1. ✅ **精确性**：毫秒级精度，满足区块链验证需求
2. ✅ **跨平台**：JavaScript、区块链、后端都兼容
3. ✅ **时区无关**：存储 UTC，前端自动转换当地时间
4. ✅ **排序友好**：数字类型，高效排序和比较

### 2.2 页面结构

```
/                       # 首页 - 一体化游戏面板（核心页面）
├── /round/[id]         # 单局详情（弹窗或独立页）
├── /verify             # 验证工具
└── /about              # 关于项目
```

### 2.3 首页一体化布局

首页包含三大核心功能区，用户无需跳转即可获取所有信息：

> **设计决策（2026-01-27）**：移除3D场景，采用增强版2D展示。
> - 原因：3D效果开发成本高、移动端兼容性差、核心价值在于透明可验证而非视觉效果
> - 优势：更稳定、加载更快、兼容性更好、维护成本低

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              OpenBaccarat                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  🕐 当地时间                                      📍 状态: 开奖     │    │
│  │                                                                      │    │
│  │          🎰 增强版 2D 游戏展示区 (左右布局)                         │    │
│  │                                                                      │    │
│  │    [闲] PLAYER            VS            [庄] BANKER                 │    │
│  │      🎴🎴               🏆闲赢              🎴🎴🎴                  │    │
│  │       9                                      8                       │    │
│  │                                                                      │    │
│  │           ⏱️ 下一局: 00:45  |  📊 本局: #42  |  🎴 牌靴: #1        │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  ┌──────────────────────────────┐  ┌──────────────────────────────────┐    │
│  │                              │  │                                  │    │
│  │   📜 历史记录                 │  │   👟 发牌靴追踪                   │    │
│  │                              │  │                                  │    │
│  │   #123456  庄胜  7:5  ✓      │  │   牌靴 #42                       │    │
│  │   #123455  闲胜  8:3  ✓      │  │   已使用: 156/416 张              │    │
│  │   #123454  和局  6:6  ✓      │  │   已进行: 28 局                  │    │
│  │   #123453  庄胜  9:0  ✓      │  │                                  │    │
│  │   #123452  闲胜  7:4  ✓      │  │   ┌──────────────────────────┐  │    │
│  │   ...                        │  │   │ ♠A ♥2 ♦K ♣7 ♠9 ♥J ...   │  │    │
│  │                              │  │   │ (已使用的牌可视化)        │  │    │
│  │   [筛选] [搜索局号]           │  │   └──────────────────────────┘  │    │
│  │                              │  │                                  │    │
│  └──────────────────────────────┘  └──────────────────────────────────┘    │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

**布局说明：**

| 区域 | 位置 | 功能 |
|------|------|------|
| 🎰 游戏展示区 | 顶部主区域 | 增强版2D牌桌、翻牌动画、倒计时、当前局信息 |
| 📜 历史记录 | 左下面板 | 最近游戏记录列表、筛选、搜索、点击查看详情 |
| 👟 发牌靴追踪 | 右下面板 | 当前牌靴状态、已使用牌数、已用牌可视化 |

**游戏展示区特性：**

| 特性 | 描述 |
|------|------|
| 仿真赌桌背景 | 深绿色渐变 + 纹理图案 + 金色边框 |
| 精美扑克牌 | 3D翻牌效果、光泽动画、左上右下双角设计 |
| 发牌动画 | 卡片依次出现、交错延迟、平滑过渡 |
| 结果高亮 | 获胜方发光效果、点数脉冲动画 |
| 实时信息 | 当地时间、倒计时、局号、牌靴号 |

**响应式适配：**

| 设备 | 布局调整 |
|------|----------|
| 桌面 (≥1280px) | 三区并列，完整展示 |
| 平板 (768-1279px) | 游戏区顶部，历史/牌靴两列底部 |
| 手机 (<768px) | 游戏区顶部，历史/牌靴切换Tab |

### 2.4 数据模型

#### 2.3.1 游戏局 (Game Round)

```typescript
interface GameRound {
  id: string;                    // 局号 (自增)
  shoe_id: string;               // 所属牌靴ID
  round_in_shoe: number;         // 牌靴内第几局
  
  // 发牌结果
  player_cards: Card[];          // 闲家牌 (2-3张)
  banker_cards: Card[];          // 庄家牌 (2-3张)
  player_total: number;          // 闲家点数
  banker_total: number;          // 庄家点数
  
  // 结果
  result: 'player' | 'banker' | 'tie';
  player_pair: boolean;          // 闲对
  banker_pair: boolean;          // 庄对
  
  // 时间
  started_at: Date;
  completed_at: Date;
  
  // 区块链
  solana_signature: string;      // Solana 交易签名
  solana_slot: number;           // 区块 slot
  vrf_seed: string;              // VRF 随机种子
}
```

#### 2.3.2 扑克牌 (Card)

```typescript
interface Card {
  suit: 'spades' | 'hearts' | 'diamonds' | 'clubs';
  rank: 'A' | '2' | '3' | '4' | '5' | '6' | '7' | '8' | '9' | '10' | 'J' | 'Q' | 'K';
  value: number;                 // 百家乐点数 (0-9)
  position: number;              // 在牌靴中的位置
}
```

#### 2.3.3 发牌靴 (Shoe)

```typescript
interface Shoe {
  id: string;
  deck_count: 8;                 // 固定8副牌
  total_cards: 416;              // 总牌数
  
  // 初始化
  initial_burn_count: number;    // 开头烧牌数
  cut_card_position: number;     // 切牌卡位置
  
  // 状态
  cards_used: number;            // 已使用牌数
  rounds_played: number;         // 已进行局数
  used_cards: Card[];            // 已使用的牌列表
  
  // 时间
  started_at: Date;
  ended_at?: Date;
  
  // 区块链
  shuffle_seed: string;          // 洗牌种子 (VRF)
  solana_signature: string;
}
```

---

## 3. 游戏规则实现

### 3.1 百家乐规则

#### 3.1.1 点数计算

| 牌面 | 点数 |
|------|------|
| A | 1 |
| 2-9 | 牌面数字 |
| 10, J, Q, K | 0 |

点数 = 所有牌点数之和 mod 10

#### 3.1.2 补牌规则

**闲家补牌规则：**
| 闲家前两张点数 | 动作 |
|----------------|------|
| 0-5 | 补牌 |
| 6-7 | 不补 |
| 8-9 | 天牌，双方都不补 |

**庄家补牌规则（当闲家不补牌时）：**
| 庄家前两张点数 | 动作 |
|----------------|------|
| 0-5 | 补牌 |
| 6-7 | 不补 |

**庄家补牌规则（当闲家补牌时）：**
| 庄家点数 | 闲家第三张牌 | 庄家动作 |
|----------|-------------|----------|
| 0-2 | 任意 | 补牌 |
| 3 | 0-7, 9 | 补牌 |
| 3 | 8 | 不补 |
| 4 | 2-7 | 补牌 |
| 4 | 0-1, 8-9 | 不补 |
| 5 | 4-7 | 补牌 |
| 5 | 0-3, 8-9 | 不补 |
| 6 | 6-7 | 补牌 |
| 6 | 0-5, 8-9 | 不补 |
| 7 | 任意 | 不补 |

#### 3.1.3 胜负判定

- 点数大者胜
- 点数相同为和局

### 3.2 发牌靴规则

#### 3.2.1 初始化

1. 使用 8 副标准扑克牌（416张）
2. 使用 VRF 生成随机种子
3. Fisher-Yates 算法洗牌
4. 翻开第一张牌，根据点数烧牌（10/J/Q/K = 10张）
5. 在距离底部约 14-16 张处插入切牌卡

#### 3.2.2 结束条件

- 当切牌卡被发出后，完成当前局
- 开始新的牌靴

### 3.3 VRF 随机数

```
VRF 输入：
  - 上一个区块哈希
  - 牌靴/局号
  - 预言机私钥

VRF 输出：
  - 可验证的随机数
  - 证明（任何人可验证）
```

---

## 4. 用户界面设计

### 4.1 设计风格

- **主题**：深色奢华赌场风格
- **色调**：深绿（赌桌）+ 金色（装饰）+ 红色（扑克牌）
- **质感**：拟物化、3D 光影、玻璃效果

### 4.2 核心交互

#### 4.2.1 翻牌动画

1. **发牌阶段**
   - 牌从牌靴滑出
   - 飞向闲家/庄家位置
   - 背面朝上落定

2. **咪牌阶段**（核心卖点）
   - 牌角缓慢翘起
   - 牌面弧形弯曲
   - 逐渐露出点数
   - 柔软的纸张质感
   - 真实的光影反射

3. **翻牌阶段**
   - 完全翻开
   - 光泽闪烁效果
   - 点数高亮显示

#### 4.2.2 倒计时

- 圆形进度条
- 最后10秒加速动画
- 下一局预告

### 4.3 响应式设计

| 设备 | 布局 |
|------|------|
| 桌面 (≥1280px) | 顶部3D牌桌 + 底部双栏（历史记录 / 牌靴追踪） |
| 平板 (768-1279px) | 顶部3D牌桌 + 底部双栏（缩小版） |
| 手机 (<768px) | 顶部简化3D + 底部Tab切换（历史 / 牌靴） |

---

## 5. 系统架构

### 5.1 整体架构

```
┌─────────────────────────────────────────────────────────────────┐
│                          用户浏览器                              │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                    Next.js 前端                          │    │
│  │  ┌───────────┐  ┌───────────┐  ┌───────────┐            │    │
│  │  │  React    │  │  React    │  │  Zustand  │            │    │
│  │  │  Three    │  │  Components│  │  State    │            │    │
│  │  │  Fiber    │  │           │  │           │            │    │
│  │  └───────────┘  └───────────┘  └───────────┘            │    │
│  └─────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                     Next.js API Routes                           │
│  ┌───────────┐  ┌───────────┐  ┌───────────┐  ┌───────────┐     │
│  │ /api/game │  │ /api/     │  │ /api/shoe │  │ /api/     │     │
│  │ /current  │  │ history   │  │           │  │ verify    │     │
│  └───────────┘  └───────────┘  └───────────┘  └───────────┘     │
└─────────────────────────────────────────────────────────────────┘
                              │
              ┌───────────────┼───────────────┐
              ▼               ▼               ▼
┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐
│    Supabase     │  │  游戏引擎服务    │  │     Solana      │
│  (PostgreSQL)   │  │  (Node.js)      │  │   Blockchain    │
│                 │  │                 │  │                 │
│ - 历史记录索引   │  │ - 游戏循环      │  │ - 结果存证      │
│ - 牌靴状态      │  │ - VRF 调用      │  │ - VRF 验证      │
│ - 快速查询      │  │ - 状态广播      │  │ - 永久存储      │
└─────────────────┘  └─────────────────┘  └─────────────────┘
```

### 5.2 数据流

```
1. 游戏循环（每分钟）
   ┌─────────────────────────────────────────────────────────┐
   │  VRF 请求 → 随机数生成 → 发牌计算 → 结果判定            │
   │      ↓                                                   │
   │  写入 Solana → 等待确认 → 同步到 Supabase → 广播前端    │
   └─────────────────────────────────────────────────────────┘

2. 用户查询
   ┌─────────────────────────────────────────────────────────┐
   │  用户请求 → API Route → Supabase 查询 → 返回结果        │
   │                              ↓                          │
   │                     (可选) 链上验证                      │
   └─────────────────────────────────────────────────────────┘
```

### 5.3 实时更新

使用 **Server-Sent Events (SSE)** 推送：
- 当前游戏状态
- 倒计时同步
- 新局开始通知
- 结果公布

---

## 6. 安全考虑

### 6.1 随机数安全

- 使用 Solana VRF 预言机（Switchboard/Orao）
- 随机数在链上生成，不可预测
- 任何人可验证随机数的真实性

### 6.2 数据完整性

- 所有游戏结果写入 Solana
- 数据库仅作为索引，不是真相源
- 用户可随时对比链上数据

### 6.3 代码安全

- 完全开源，接受社区审计
- 无后门、无隐藏逻辑
- 使用知名开源库

---

## 7. 性能要求

| 指标 | 目标 |
|------|------|
| 首屏加载 | < 3s |
| 3D 渲染帧率 | ≥ 60 FPS |
| API 响应 | < 100ms |
| 历史查询 | < 200ms |
| 链上确认 | < 2s (Solana) |

---

## 8. 未来扩展

### Phase 2
- 多语言支持 (i18n)
- 统计分析面板
- 路单图表（大路、大眼仔等）

### Phase 3
- 移动端 App (React Native)
- 更多游戏类型
- API 开放给第三方